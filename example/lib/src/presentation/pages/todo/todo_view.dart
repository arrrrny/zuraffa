// Generated by zfa
// zfa generate Todo --methods=get,watch,create,update,delete,getList,watchList --vpc
// ignore_for_file: no_logic_in_create_state

import 'package:flutter/material.dart';
import 'package:zuraffa/zuraffa.dart';
import '../../../domain/repositories/todo_repository.dart';
import '../../../domain/entities/todo/todo.dart';
import 'todo_controller.dart';
import 'todo_presenter.dart';
import 'todo_state.dart';

class TodoView extends CleanView {
  final TodoRepository todoRepository;

  const TodoView({
    super.key,
    super.routeObserver,
    required this.todoRepository,
  });

  @override
  State<TodoView> createState() => _TodoViewState(
    TodoController(TodoPresenter(todoRepository: todoRepository)),
  );
}

class _TodoViewState extends CleanViewState<TodoView, TodoController> {
  _TodoViewState(super.controller);

  final _textController = TextEditingController();

  @override
  void onInitState() {
    super.onInitState();
    // Start watching the list when view initializes
    controller.watchTodoList();
  }

  @override
  void dispose() {
    _textController.dispose();
    super.dispose();
  }

  @override
  Widget get view {
    return Scaffold(
      key: globalKey,
      appBar: AppBar(title: const Text('Clean Architecture Demo')),
      body: Column(
        children: [
          // Error banner
          _buildErrorBanner(),

          // Todo input
          _buildTodoInput(),

          // Todo list
          Expanded(child: _buildTodoList()),

          // Stats footer
          _buildStatsFooter(),
        ],
      ),
    );
  }

  Widget _buildErrorBanner() {
    return ControlledWidgetSelector<TodoController, AppFailure?>(
      selector: (controller) => controller.viewState.error,
      builder: (context, error) {
        if (error == null) return const SizedBox.shrink();

        return MaterialBanner(
          backgroundColor: Colors.red.shade100,
          content: Text(
            error.message, // Simplified error formatting
            style: TextStyle(color: Colors.red.shade900),
          ),
          actions: [
            TextButton(
              onPressed: () => controller.clearError(),
              child: const Text('DISMISS'),
            ),
          ],
        );
      },
    );
  }

  Widget _buildTodoInput() {
    return Padding(
      padding: const EdgeInsets.all(16),
      child: Row(
        children: [
          Expanded(
            child: TextField(
              controller: _textController,
              decoration: const InputDecoration(
                hintText: 'What needs to be done?',
                border: OutlineInputBorder(),
              ),
              onSubmitted: (_) => _createTodo(),
            ),
          ),
          const SizedBox(width: 12),
          ControlledWidgetSelector<TodoController, bool>(
            selector: (controller) => controller.viewState.isCreating,
            builder: (context, isCreating) {
              return ElevatedButton(
                onPressed: isCreating ? null : _createTodo,
                child: isCreating
                    ? const SizedBox(
                        width: 20,
                        height: 20,
                        child: CircularProgressIndicator(strokeWidth: 2),
                      )
                    : const Text('Add'),
              );
            },
          ),
        ],
      ),
    );
  }

  Widget _buildTodoList() {
    return ControlledWidgetBuilder<TodoController>(
      builder: (context, controller) {
        final state = controller.viewState;

        if (state.isLoading && state.todos.isEmpty) {
          return const Center(child: CircularProgressIndicator());
        }

        if (state.todos.isEmpty) {
          return Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(
                  Icons.check_circle_outline,
                  size: 64,
                  color: Colors.grey.shade400,
                ),
                const SizedBox(height: 16),
                Text(
                  'No todos yet!',
                  style: TextStyle(fontSize: 18, color: Colors.grey.shade600),
                ),
                const SizedBox(height: 8),
                Text(
                  'Add one above to get started.',
                  style: TextStyle(color: Colors.grey.shade500),
                ),
              ],
            ),
          );
        }

        return ListView.builder(
          itemCount: state.todos.length,
          itemBuilder: (context, index) {
            final todo = state.todos[index];
            return _buildTodoItem(todo);
          },
        );
      },
    );
  }

  Widget _buildTodoItem(Todo todo) {
    return Dismissible(
      key: ValueKey(todo.id),
      direction: DismissDirection.endToStart,
      background: Container(
        color: Colors.red,
        alignment: Alignment.centerRight,
        padding: const EdgeInsets.only(right: 16),
        child: const Icon(Icons.delete, color: Colors.white),
      ),
      onDismissed: (_) => controller.deleteTodo(todo.id),
      child: ListTile(
        onTap: () => controller.toggleTodo(todo.id),
        leading: Checkbox(
          value: todo.isCompleted,
          onChanged: (_) => controller.toggleTodo(todo.id),
        ),
        title: Text(
          todo.title,
          style: TextStyle(
            decoration: todo.isCompleted ? TextDecoration.lineThrough : null,
            color: todo.isCompleted ? Colors.grey : null,
          ),
        ),
        subtitle: Text(
          'Created ${_formatDate(todo.createdAt)}',
          style: TextStyle(fontSize: 12, color: Colors.grey.shade600),
        ),
      ),
    );
  }

  Widget _buildStatsFooter() {
    return ControlledWidgetSelector<TodoController, TodoState>(
      selector: (controller) => controller.viewState,
      builder: (context, state) {
        if (state.todoList.isEmpty) return const SizedBox.shrink();

        return Container(
          padding: const EdgeInsets.all(16),
          decoration: BoxDecoration(
            color: Colors.grey.shade100,
            border: Border(top: BorderSide(color: Colors.grey.shade300)),
          ),
          child: Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(
                '${state.todoList.filter(TodoFields.isCompleted.eq(false)).length} active',
                style: const TextStyle(fontWeight: FontWeight.bold),
              ),
              const SizedBox(width: 24),
              Text(
                '${state.todoList.filter(TodoFields.isCompleted.eq(true)).length} completed',
                style: TextStyle(color: Colors.grey.shade600),
              ),
            ],
          ),
        );
      },
    );
  }

  void _createTodo() {
    final title = _textController.text;
    if (title.isNotEmpty) {
      final newTodo = Todo(
        id: 0, // ID will be assigned by repo
        title: title,
        createdAt: DateTime.now(),
        isCompleted: false,
      );
      controller.createTodo(newTodo).then((_) {
        _textController.clear();
      });
    }
  }

  String _formatDate(DateTime date) {
    final now = DateTime.now();
    final diff = now.difference(date);

    if (diff.inMinutes < 1) {
      return 'just now';
    } else if (diff.inHours < 1) {
      return '${diff.inMinutes}m ago';
    } else if (diff.inDays < 1) {
      return '${diff.inHours}h ago';
    } else {
      return '${diff.inDays}d ago';
    }
  }
}

extension TodoStateExtension on TodoState {
  // Aliasing property names to match example code expectations if needed,
  // simply reusing the ones we added or existing ones.
  List<Todo> get todos => todoList;
}
