---
sidebar_position: 1
title: Dependency Injection
---

# Dependency Injection Generation

Zuraffa can automatically generate dependency injection setup using get_it, eliminating the last manual step in Clean Architecture setup.

## Quick Start

```bash
# Generate DI files alongside your code
zfa generate Product --methods=get,getList,create --repository --data --vpc --di

# Use mock datasource in DI (for development/testing)
zfa generate Product --methods=get,getList --repository --data --mock --di --use-mock

# With caching enabled
zfa generate Product --methods=get,getList --repository --data --cache --di
```

## Generated Structure

```
lib/src/di/
├── index.dart                    # Main entry with setupDependencies()
├── datasources/
│   ├── index.dart               # Auto-generated
│   └── product_remote_data_source_di.dart
├── repositories/
│   ├── index.dart               # Auto-generated
│   └── product_repository_di.dart
├── usecases/
│   ├── index.dart               # Auto-generated
│   ├── get_product_usecase_di.dart
│   └── get_product_list_usecase_di.dart
├── presenters/
│   ├── index.dart               # Auto-generated
│   └── product_presenter_di.dart
└── controllers/
    ├── index.dart               # Auto-generated
    └── product_controller_di.dart
```

## Usage

### Setup

```dart
import 'package:get_it/get_it.dart';
import 'src/di/index.dart';

void main() {
  final getIt = GetIt.instance;
  setupDependencies(getIt);
  
  runApp(MyApp());
}
```

### Access Dependencies

```dart
// Get repository
final productRepository = getIt<ProductRepository>();

// Get controller
final productController = getIt<ProductController>();

// Use in widgets
class ProductView extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final controller = getIt<ProductController>();
    return Scaffold(
      body: ControlledWidgetBuilder<ProductController>(
        builder: (context, controller) {
          // Your UI
        },
      ),
    );
  }
}
```

## Features

### One File Per Component

Each component gets its own registration file, preventing merge conflicts:

```dart
// lib/src/di/repositories/product_repository_di.dart
import 'package:get_it/get_it.dart';
import '../../domain/repositories/product_repository.dart';
import '../../data/repositories/data_product_repository.dart';
import '../../data/data_sources/product/product_remote_data_source.dart';

void registerProductRepository(GetIt getIt) {
  getIt.registerLazySingleton<ProductRepository>(
    () => DataProductRepository(getIt<ProductRemoteDataSource>()),
  );
}
```

### Auto-Generated Indexes

Index files are automatically regenerated by scanning directories:

```dart
// lib/src/di/repositories/index.dart
import 'package:get_it/get_it.dart';
import 'product_repository_di.dart';
import 'user_repository_di.dart';

void registerAllRepositories(GetIt getIt) {
  registerProductRepository(getIt);
  registerUserRepository(getIt);
}
```

### Cache Support

When `--cache` is used, both remote and local datasources are registered:

```dart
void registerProductRepository(GetIt getIt) {
  getIt.registerLazySingleton<ProductRepository>(
    () => DataProductRepository(
      getIt<ProductRemoteDataSource>(),
      getIt<ProductLocalDataSource>(),
      getIt<CachePolicy>(),
    ),
  );
}
```

### Mock Support

Use `--use-mock` to register mock datasources instead of remote:

```bash
zfa generate Product --methods=get,getList --repository --data --mock --di --use-mock
```

```dart
void registerProductRepository(GetIt getIt) {
  getIt.registerLazySingleton<ProductRepository>(
    () => DataProductRepository(getIt<ProductMockDataSource>()),
  );
}
```

## Registration Patterns

| Component | Registration Type | Reason |
|-----------|------------------|---------|
| DataSource | `registerLazySingleton` | Shared instance, created on first use |
| Repository | `registerLazySingleton` | Shared instance, created on first use |
| UseCase | `registerFactory` | New instance per request |
| Presenter | `registerFactory` | New instance per screen |
| Controller | `registerFactory` | New instance per screen |

## Regeneration

The DI system is fail-safe and can be regenerated anytime:

```bash
# Regenerate DI files without touching other code
zfa generate Product --methods=get,getList --di --force
```

Index files are automatically updated by scanning the directory structure, so you never need to manually merge registration code.

## Best Practices

### 1. Separate DI Setup

Keep your DI setup in a separate file:

```dart
// lib/src/di/setup.dart
import 'package:get_it/get_it.dart';
import 'index.dart';

final getIt = GetIt.instance;

Future<void> setupDI() async {
  // Setup generated dependencies
  setupDependencies(getIt);
  
  // Add custom registrations
  getIt.registerLazySingleton(() => HttpClient());
  getIt.registerLazySingleton(() => CachePolicy.daily());
}
```

### 2. Initialize Early

Call setup in `main()` before running the app:

```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await setupDI();
  runApp(MyApp());
}
```

### 3. Use Mock in Development

Switch between mock and real datasources easily:

```dart
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Use environment variable or build flavor
  const useMock = bool.fromEnvironment('USE_MOCK', defaultValue: false);
  
  if (useMock) {
    // Regenerate with: zfa generate Product --di --use-mock --force
    await setupDI();
  } else {
    await setupDI();
  }
  
  runApp(MyApp());
}
```

## Troubleshooting

### Circular Dependencies

If you encounter circular dependencies, check your repository dependencies:

```dart
// ❌ Bad: Circular dependency
class ProductRepository {
  final UserRepository userRepository;
}

class UserRepository {
  final ProductRepository productRepository;
}

// ✅ Good: Use a shared service
class ProductRepository {
  final ApiService apiService;
}

class UserRepository {
  final ApiService apiService;
}
```

### Missing Registrations

If a dependency is not found, ensure the DI file was generated:

```bash
# Check if DI files exist
ls lib/src/di/repositories/

# Regenerate if missing
zfa generate Product --methods=get,getList --repository --data --di --force
```
